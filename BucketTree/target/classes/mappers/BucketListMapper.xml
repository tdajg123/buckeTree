<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.ac.BucketTree.BucketListMapper">

	<!-- ##버킷리스트 전체 목록(list.jsp) 시작...## -->
	<!-- 버킷리스트 전체 목록 &정렬&검색-->
	<select id="list" resultType="kr.ac.BucketTree.vo.BucketListVO">

		<![CDATA[
			SELECT *
			FROM 
			(
			 SELECT *, CASE #{orderType}
						   WHEN 1 THEN ROW_NUMBER() OVER(ORDER BY date desc)			/*최신순*/
						   WHEN 2 THEN ROW_NUMBER() OVER(ORDER BY count desc)			/*인기순*/
						END row
			FROM [BucketList]
			WHERE
				IDX > 0 AND WRITER IN(0,1)
		    AND
		     (
			 (#{srchType}= 0) OR  /*검색조건이 없을때 */
			 (#{srchType}= 1 AND CHARINDEX(#{srchText}, title) >= 1) OR /*질문 제목*/
			 (#{srchType}= 2 AND CHARINDEX(#{srchText}, title) >= 1 OR CHARINDEX(#{srchText}, contents) >= 1) OR /*질문 제목이나 내용*/
			 (#{srchType}= 3 AND #{srchText} IN (select name from [User])) 
			 )  /*질문 작성자*/
		     
			 and 
			 (
			 (#{categoryType} = 0) OR
			 (#{categoryType} = 1 AND [WHEN]=#{when} and [WHO]=#{who} and [WHAT] =#{what})
			 ) /*카테고리검색*/
			 
			)subquery
			WHERE row>(#{currentPage} - 1) * #{pageSize} and
		        row <= (#{currentPage} *#{pageSize})
			ORDER BY row 
		]]>

	</select>

	<!-- 버킷리스트 페이지 카운트 -->
	<select id="listCount" resultType="int"> 

	<![CDATA[
		SELECT COUNT(*)
		FROM [BucketList] b, [USER] u
		WHERE
			b.IDX > 0 AND b.WRITER IN(0,1)
		and
	     (
		 (#{srchType}= 0) OR  /*검색조건이 없을때 */
		 (#{srchType}= 1 AND CHARINDEX(#{srchText},b.title)>=1) OR /*질문 제목*/
		 (#{srchType}= 2 AND CHARINDEX(#{srchText},b.title)>=1 OR CHARINDEX(#{srchText},b.contents)>=1) OR /*질문 제목이나 내용*/
		 (#{srchType}= 3 AND CHARINDEX(#{srchText},u.name)=1) 
		 )  /*질문 작성자*/
	     
		 and 
		 (
		 (#{categoryType}=0) OR
		 (#{categoryType}=1 AND[when]=#{when} and [who]=#{who} and [what] =#{what})
		 ) /*카테고리검색*/
	   
	]]>

	</select>

	<!-- 버킷리스트-무한스크롤 -->
	<select id="listAjax" resultType="kr.ac.BucketTree.vo.BucketListVO" >
		
			SELECT *
			FROM 
			(
			 SELECT b.*, CASE #{orderType}
						   WHEN 1 THEN ROW_NUMBER() OVER(ORDER BY b.date desc)			/*최신순*/
						   WHEN 2 THEN ROW_NUMBER() OVER(ORDER BY b.count desc)			/*인기순*/
						END row
			FROM [BucketList] b
			WHERE
				b.IDX > 0 AND b.WRITER IN(0,1)
		    AND
		     (
			 (#{srchType}= 0) OR  /*검색조건이 없을때 */
			 (#{srchType}= 1 AND CHARINDEX(#{srchText}, b.title) >= 1) OR /*질문 제목*/
			 (#{srchType}= 2 AND CHARINDEX(#{srchText}, b.title) >= 1 OR CHARINDEX(#{srchText}, b.contents) >= 1) OR /*질문 제목이나 내용*/
			 (#{srchType}= 3 AND #{srchText} IN (select name from [User])) 
			 )  /*질문 작성자*/
		     
			 and 
			 (
			 (#{categoryType}=0) OR
			 (#{categoryType}=1 AND [WHEN]=#{when} and [WHO]=#{who} and [WHAT] =#{what})
			 ) /*카테고리검색*/
			 
			 
			) subquery
			<![CDATA[
			WHERE row > #{row} AND row <= #{row} + #{pageSize}
			]]>
			ORDER BY row
		
	</select>
	
	<!-- 각 리스트에서 해당 버킷리스트의 첫번째 이미지로 보이기 -->
	<select id="listImage" resultType="kr.ac.BucketTree.vo.BucketListVO">
		SELECT TOP 1 image_idx
		FROM [BucketList_Image]
		WHERE BUCKET_IDX = #{bucket_idx}
	</select>
	

	<!-- 전체 : 담기-버킷 카운트 업 -->
	<update id="countUp">

		UPDATE [BucketList]
		SET COUNT = COUNT + 1
		WHERE IDX =
		#{idx}

	</update>

	<!-- 전체 : 버킷 버튼 클릭 시 마이 버킷리스트에 추가 -->
	<insert id="addBucket" parameterType="hashmap">

		INSERT
		INTO
		[BucketList](title, contents, count, date, user_idx, writer, [when],
		who, what, state)
		values(#{title}, #{contents}, 0, GETDATE(),
		#{user_idx}, #{writer}, #{when}, #{who}, #{what}, 0)

	</insert>

	<!-- 전체 : 버킷 버튼 클릭 시 중복 담기 방지로 해당 버킷의 idx를 넣어줌 -->
	<!-- : parameterType을 haspmap으로 받아 여러개 인자를 받아옴 -->
	<select id="titleCheck" resultType="int" parameterType="hashmap">
		SELECT
		COUNT(1)
		FROM [BucketList]
		WHERE [title] = #{title} AND user_idx =
		#{userIdx} AND writer = 2

	</select>

	<!-- ##버킷리스트 전체 목록 끝...## -->


	<!-- ##버킷리스트 내 목록(mylist.jsp) 시작...## -->
	<!-- 버킷리스트 내 목록 -->
	<select id="mylist" resultType="kr.ac.BucketTree.vo.BucketListVO">

		<![CDATA[
			SELECT *
			FROM 
			(
			 SELECT *, CASE #{orderType}
						   WHEN 1 THEN ROW_NUMBER() OVER(ORDER BY date desc)			/*최신순*/
						   WHEN 2 THEN ROW_NUMBER() OVER(ORDER BY count desc)			/*인기순*/
						END row
			FROM [BucketList]
			WHERE
				IDX > 0 AND WRITER = 2
		    AND
		     (
			 (#{srchType}= 0) OR  /*검색조건이 없을때 */
			 (#{srchType}= 1 AND CHARINDEX(#{srchText}, title) >= 1) OR /*질문 제목*/
			 (#{srchType}= 2 AND CHARINDEX(#{srchText}, title) >= 1 OR CHARINDEX(#{srchText}, contents) >= 1) OR /*질문 제목이나 내용*/
			 (#{srchType}= 3 AND #{srchText} IN (select name from [User])) 
			 )  /*질문 작성자*/
		     
			 and 
			 (
			 (#{categoryType} = 0) OR
			 (#{categoryType} = 1 AND [WHEN]=#{when} and [WHO]=#{who} and [WHAT] =#{what})
			 ) /*카테고리검색*/
			 
			)subquery
			WHERE row>(#{currentPage} - 1) * #{pageSize} and
		        row <= (#{currentPage} *#{pageSize})
			ORDER BY row 
		]]>

	</select>
	
	<!-- 마이리스트-무한스크롤 -->
	<select id="mylistAjax" resultType="kr.ac.BucketTree.vo.BucketListVO" >
		SELECT *
			FROM 
			(
			 SELECT *
			FROM [BucketList]
			WHERE
				IDX > 0 AND WRITER =2
		    AND
		     (
			 (#{srchType}= 0) OR  /*검색조건이 없을때 */
			 (#{srchType}= 1 AND CHARINDEX(#{srchText}, title) >= 1) OR /*질문 제목*/
			 (#{srchType}= 2 AND CHARINDEX(#{srchText}, title) >= 1 OR CHARINDEX(#{srchText}, contents) >= 1) OR /*질문 제목이나 내용*/
			 (#{srchType}= 3 AND #{srchText} IN (select name from [User])) 
			 )  /*질문 작성자*/
		     
			 and 
			 (
			 (#{categoryType}=0) OR
			 (#{categoryType}=1 AND [WHEN]=#{when} and [WHO]=#{who} and [WHAT] =#{what})
			 ) /*카테고리검색*/
			 
			 
			) subquery
			<![CDATA[
			WHERE row > #{row} AND row <= #{row} + #{pageSize}
			]]>
			ORDER BY row
		
	</select>

	<!-- 버킷리스트 친구 추천 목록 -->
	<select id="recommendList" resultType="kr.ac.BucketTree.vo.RecommendVO">

		SELECT TOP 3
		RBL.BucketList_Idx, BL.title, BL.contents
		FROM [RecommendBucketList]
		RBL, [BucketList] BL
		WHERE RBL.BucketList_idx = BL.idx AND RBL.fromUser = #{fromUser}
		ORDER BY NEWID()

	</select>

	<!-- 버킷리스트 관리자 추천 목록 -->
	<select id="adminRecommendList" resultType="kr.ac.BucketTree.vo.BucketListVO">

		SELECT TOP 3 idx,
		title, contents
		FROM [BucketList]
		WHERE user_idx != 4 AND WHAT =(SELECT
		WHAT
		FROM(
		SELECT WHAT, ROW_NUMBER() OVER(ORDER BY COUNT(WHAT) DESC) row
		FROM BucketList
		WHERE user_Idx = 4 AND STATE = 1
		GROUP BY WHAT
		)SUBQUERY
		WHERE row = 1
		)
		ORDER BY NEWID()

	</select>

	<!-- ##버킷리스트 내 목록 시작...## -->
	<select id="bucketShare_MyBucketList" resultType="kr.ac.BucketTree.vo.BucketListVO">

		SELECT b.*,what.what as what_name ,[when].[when] as when_name, who.who as who_name
		FROM [BucketList] b join Category_What what
		ON b.what =what.idx
		JOIN Category_WHO who
		ON b.who =who.idx
		JOIN Category_When [when]
		ON b.[when] =[when].idx
		where user_idx=#{user_idx}
	
	</select>
	
	<!-- ##버킷리스트 내 목록 시작...## -->
	<!-- 버킷리스트 등록 -->
	<insert id="insertBucketList" useGeneratedKeys="true"
		keyProperty="idx">
		INSERT INTO
		[BucketList](title,contents,count,date,user_idx,writer,x,y,keyword,[when],who,what,tree_idx,state)
		VALUES(#{title},#{contents},#{count},GETDATE(),#{user_idx},#{writer},#{x},#{y},#{keyword},#{when},#{who},#{what},0,0)

	</insert>

	<!-- 아이디로 버킷리스트 조회 -->
	<select id="bucket" resultType="kr.ac.BucketTree.vo.BucketListVO">

		SELECT *
		FROM [BucketList]
		WHERE
		IDX =#{idx}

	</select>
	<!-- Image 테이블 삽입 -->
	<insert id="insertbImage" useGeneratedKeys="true" keyProperty="idx">
		INSERT INTO [Image] (fileName, fileSize, fileTime, data)
		VALUES (#{fileName}, #{fileSize}, GETDATE(), #{data})
	</insert>

	<!-- 잔여 이미지 제거 -->
	<delete id="deleteOrphan">
		DELETE [Image] 
		<![CDATA[
	WHERE idx NOT IN (SELECT image_idx FROM [BucketList_Image]) AND DATEDIFF(minute, fileTime, GETDATE()) > 60
			]]>
	</delete>

	<!-- BucketList_Image 테이블 삽입 -->
	<insert id="insertblImage">
		INSERT INTO [BucketList_Image] (bucket_idx, image_idx) VALUES
		(#{bucket_idx}, #{image_idx})
	</insert>
	
	<!-- Image 테이블 idx로 레코드 제거 -->
	<delete id="deleteImage">
	DELETE FROM [Image] WHERE idx=#{idx}
	</delete>
	
	<!-- 버킷리스트 idx에 해당하는 BucketList_image 레코드 제거 -->
	<delete id="deleteByBucketIdx">
		DELETE FROM [BucketList_Image] WHERE bucket_idx = #{bucket_idx}
	</delete>

	<!-- 아이디로 이미지 테이블 레코드 조회 -->
	<select id="selectById" resultType="kr.ac.BucketTree.vo.ImageVO">
		SELECT *
		FROM [Image]
		WHERE idx=#{idx}
	</select>
	
	<!-- 버킷아이디로 BucketList_image 테이블 image_idx 조회 -->
	<select id="selectByImageIdx" resultType="int">
		SELECT image_idx
		FROM [BucketList_Image]
		WHERE bucket_idx=#{idx}
	</select>
	
	
	<!-- 버킷리스트 수정 -->
	<insert id="editBucket">
		UPDATE BucketList SET contents=#{contents}, x =#{x}, y = #{y} WHERE idx=
		#{idx};
	</insert>
	<!-- 버킷리스트 삭제 -->
	<delete id="deleteBucket">
		DELETE FROM [BucketList] WHERE idx=#{idx}
	</delete>
	
	<!-- 댓글 등록 -->
	<insert id="insertComment" useGeneratedKeys="true" keyProperty="idx">
	 INSERT INTO [BucketList_Comment](bucketList_idx,name,user_idx,date,contents,author) VALUES(#{bucketList_idx},#{name},#{user_idx},getDate(),#{contents},#{author})
	
	</insert>
	
	<!-- 댓글 전체 조회 -->
	<select id="selectComment" resultType="kr.ac.BucketTree.vo.CommentVO">
	SELECT * FROM [BucketList_Comment] WHERE bucketList_idx=#{idx}
	</select>

	
	<!-- 댓글 조회 -->
	<select id="selectByIdxComment" resultType="kr.ac.BucketTree.vo.CommentVO">
	SELECT * FROM [BucketList_Comment] WHERE idx=#{idx}
	</select>
	<!-- 댓글 삭제 -->
	<delete id="deleteComment">
	DELETE FROM [BucketList_Comment] WHERE idx=#{idx}	
	</delete>
	
	<!-- 버킷 삭제시 댓글 삭제 -->	
	<delete id="deleteBucComment">
	DELETE FROM [BucketList_Comment] WHERE bucketList_idx= #{idx}
	</delete>
	
	<!-- 댓글 수정 -->
	<update id="updateComment">
	UPDATE [BucketList_Comment] SET contents=#{contents} WHERE idx=#{idx}
	
	</update>
</mapper>